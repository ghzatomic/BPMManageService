package br.com.finchsolucoes.ominipage.omini;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.net.Socket;

/**
 * 
 * Classe responsï¿½vel por
 *
 * @since 21 de set de 2015 15:43:38
 * @author Luiz Gustavo O. Gutierrez <luizgutierrez@finchsolucoes.com.br>
 *
 */
public class JobRunnerOmniPage{
	private static String fileName;
	private static long currentTime;
	private static String pathParamters;

	public void runJob( long fileName ) {
		
		BufferedInputStream in         = null;
        BufferedInputStream procStdout = null;
        BufferedOutputStream out       = null;
        StringBuffer cmd               = null;
        Process proc                   = null;
		
		pathParamters = Constantes.PATH_JOB_OMNIPAGE + fileName + ".jpf";

		JobRunnerOmniPage.currentTime = fileName;
		JobRunnerOmniPage.fileName = String.valueOf( fileName );
		createJob();
		
	    //Attempt to connect
	    try {
	    	
	    	proc = Runtime.getRuntime().exec(new String(Constantes.PATH_JOB_RUNNER +" "+pathParamters));
            procStdout = new BufferedInputStream(proc.getInputStream());
            
	    } catch(Exception e) {
	        e.printStackTrace();
	    }
	}

	private static void createJob() {
		// Parametros para o criar o arquivo .JFP
		
		String pathFileOCR = Constantes.PATH_INPUT + fileName + ".pdf";
		String pathLog = Constantes.PATH_JOB_OMNIPAGE + fileName + ".xwf";
		String pathConDat1 = Constantes.PATH_JOB_OMNIPAGE + ( currentTime + 1 ) + ".dat";
		String pathConDat2 = Constantes.PATH_JOB_OMNIPAGE + ( currentTime + 2 ) + ".dat";

		// Converte as strings em hexadecimal
		JobRunnerOmniPage strToHex = new JobRunnerOmniPage();
		String hexNameJob = strToHex.convertStringToHex( Constantes.JOBNAME );
		String hexNameLog = strToHex.convertStringToHex( pathLog );
		String hexPathOCR = strToHex.convertStringToHex( pathFileOCR );
		String hexConDat1 = strToHex.convertStringToHex( pathConDat1 );
		String hexConDat2 = strToHex.convertStringToHex( pathConDat2 );
		String hexParamtersFileJPF = "2112100041004a6f6245786563506172616d7300211700004e004a6f6252756e6e696e67424d554948776e640023050026045a0002212100004e004a6f6252756e6e696e67424d746f4f50436f6e6e46696c654e616d650023a503" + hexConDat1 + "000002211b00004e004a6f6252756e6e696e67424d746f4f50436f6e6e494400230f02436f6e6e5f34354546364342390002211f000056004a6f6252756e6e696e67426172636f64655746466f6c6465727300250600000600000002211a00004e004a6f6252756e6e696e6744656c657465496e70757400a3010102211600004e004a6f6252756e6e696e674a6f624e616d6500231103" + hexNameJob + "000002211600004e004a6f6252756e6e696e674a6f6254797065002305000100000002212100004e004a6f6252756e6e696e674f50746f424d436f6e6e46696c654e616d650023a503" + hexConDat2 + "000002211b00004e004a6f6252756e6e696e674f50746f424d436f6e6e494400230f02436f6e6e5f34354546364342380002211800004e004a6f6252756e6e696e67506167654c696d6974002305002c01000002211600004e004a6f6252756e6e696e6752756e4d6f6465002305000000000002211700004e004a6f6252756e6e696e6753696c656e746c7900a3010102211b00004e004a6f6252756e6e696e6754656d70446f63756d656e7400c303000002211900004e004a6f6252756e6e696e67574646696c654e616d650023a503" + hexNameLog + "000002211b00004e004a6f6252756e6e696e675746466f6c6465725061746800238d0343003a005c00550073006500720073005c00410064006d0069006e006900730074007200610074006f0072005c0041007000700044006100740061005c0052006f0061006d0069006e0067005c005300630061006e0053006f00660074005c004f006d006e00690050006100670065002000310038005c0057006f0072006b0046006c006f0077005c00000002211b010056004a6f6252756e6e696e675746496e7075744974656d730025060100060000002107040056007630002506040005000000210900004e006b657930002315024a6f6257617463684974656d4261736555524c0002210900004e006b657931002311024a6f6257617463684974656d55524c0002210900004e0076616c300023150343003a005c0049006e007000750074005c00000002210900004e0076616c3100233703" + hexPathOCR + "000002020202";
		String hexLogFileXWF = "210a0300610069726f6f7400210903004300696e666f00210c05005600616464696e666f002506050001000000210a00004e00666e616d65002311034f00430052005f00500044004600000002210b00004e0066726e616d65002311034f00430052005f00500044004600000002210f00004e006e657874696e73746964002305001300000002210b00004e007766677569640023220236323244443841363441444334413444393743424134303430413932413230460002210e00004e0077667573657264656600a301000202210900004e0074797065002308027766646573630002210800004e00766572002309027665725f325f31000202210e06007600696e7465726661636500250606001d040000210d020076006f626a686f73743000250602001c040000210c0900630068706172616d7300210a00004e00666c616773002305000000000002210a00004e0067726f757000230500ffffffff02210b00004e00677374617465002305000000000002210900005600696e666f00250600000600000002210b000076006f626a65637400250600002204000002210e00004e006f626a696e73746964002305000400000002210b00004e006f626a75696400230905000000000000000002210b00004e006f737461746500230500f17f000002210c00005600706172656e74730025060000040000000202210c0f0043006f706172616d7300210a00004e0062666c647200c303000002210a00004e00636c736964002311070000000000000000000000000000000002210b00004e0064656665787400c303000002210a00004e00666e616d6500c303000002210900004e00666f7074002305000000000002210b00004e00666f726d617400c303000002210a00004e006674797065002305000000000002211100004e0069734163746976655061676500a3010002210b00004e006973666c647200a3010002210800004e006f757400c303000002210800004e0070776400c70316e502210a00004e00726372737600a3010002210800004e0073726300c303000002210900004e0074656d7000a3010002210900004e007573726e00c3030000020202210e0600760073746570686f73743000250606001b040000210d02007600616374686f73743000250602001a040000210b0900430061706172616d00210f00004e00616c6950444650574446002305000000004002211000004e00617370414456414e43454400a3010002211100004e00617370436f6e767354797065002305000000000002210f00004e006173705052455649455700a3010102210e00004e006173705052504154480023250343005300490044004c005f004d00590044004f00430055004d0045004e0054005300000002210d00004e006173705348444c4700a3010102211400004e0061737053494e474c4553454c45435400a3010002210c00004e0061737054595045002305000000000002210900004e0073696e6400230500000000000202210b0900630068706172616d00210b00007600616374696f6e00250600002004000002210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305000100000002210800004e00697469002305002004000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305000000000002210c00004e007468636f756e7400230500ffffffff020202210d02007600616374686f73743100250602001a040000210b1b00430061706172616d00211600004e0041504e5f4c44495f50414745434f554e54002305000000000002211000004e00616c694175746f43726f7000a3010002210d00004e00616c69424343484b00a3010002211c00004e00616c69426c616e6b5061676553656e7369746976697479002305003200000002210d00004e00616c6944424c504700a3010002210a00004e00616c69445300a3010002210e00004e00616c694465736b657700a3010102211100004e00616c694465737065636b6c6500a3010102211a00004e00616c694465737065636b6c65446974686572696e6700a3010002211500004e00616c694469676974616c43616d65726100a3010002210f00004e00616c69494e534d4f4445002305000000000002211000004e00616c69495044465441475300a3010102210e00004e00616c694c4547414c5000a3010002210c00005600616c694c616e6700250600000600000002210e00004e00616c694e4557504749002305000000000002210e00004e00616c694e4557504750002305000000000002211900004e00616c694e6577446f634174426c616e6b5061676500a3010002211800004e00616c694e6577446f63466f7245616368496d6700a3010102211000004e00616c694e6f436c7347727000a3010002210e00004e00616c69504446494d4700a3010002210f00004e00616c6950444650574446002305000000004002210d00004e00616c695047524f54002305000000000002210a00004e00616c69504c002305000000000002210d00004e00616c69504c43484b00a3010002210b00004e00616c6952504800a3010102211800004e00616c6952656d6f7665426c616e6b506167657300a3010102211400004e00616c6952656d6f766542726f64657200a301000202210b0900630068706172616d00210b02007600616374696f6e002506020021040000210c00004e00616c694163745000230500ffffffff02211200004e00616c6950496e7365727465647400a301000202210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305000200000002210800004e00697469002305002104000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305000400000002210c00004e007468636f756e740023050001000000020202210b00004e00696e73746964002305000300000002210b03005600706172616d73002506030001000000210e00004e00736c6950444650776400c70316e502210f00004e00736c6950444650776466002305000000004002210f00004e00736c695072496e70757400a301000202210a00004e007374617465002305000100000002210900007600737465700025060000030400000202210e0600760073746570686f73743100250606001b040000210d02007600616374686f73743000250602001a040000210b0100430061706172616d00210d00004e00617263414c414e4700a301010202210b0900630068706172616d00210b02007600616374696f6e002506020018040000210e00004e00617263414c414e474200a3010002210e00004e00617263414c414e475200230500138500000202210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305000500000002210800004e00697469002305001804000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305000000000002210c00004e007468636f756e740023050001000000020202210d02007600616374686f73743100250602001a040000210b1000430061706172616d00210d00004e00617263414444434800c303000002210b00004e0061726341444c00a3010002210d00004e00617263434c4f5554002305000404040002210d0000560061726346544e414d00250600000600000002210c010056006172634c414e47002506010006000000210700004e007630002305002d0000000202210d00004e006172634c4844465400a3010002210d00004e006172634c4859504c00a3010102210d00004e006172634f5054535000a3010002210d00004e0061726350434f4c4700a3010102210d00004e0061726350434f4c5400a3010102211000004e00617263504446466f6e747300a3010102210d00005600617263504449435400250600000600000002210d00004e0061726350474c4159002305000000000002210d00004e0061726352454a4348002305037e00000002210d00004e00617263524552454300a3010002210d00004e00617263554449435400c30300000202210b0900630068706172616d00210b00007600616374696f6e00250600001904000002210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305000600000002210800004e00697469002305001904000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305000000000002210c00004e007468636f756e740023050004000000020202210b00004e00696e73746964002305000700000002210b00005600706172616d7300250600000100000002210a00004e007374617465002305000100000002210900007600737465700025060000070400000202210e0600760073746570686f73743200250606001b040000210d02007600616374686f73743000250602001a040000210b1100430061706172616d00211000004e00616578434f4e564e414d4500232f0343006f006e0076006500720074006500720073002e0054006500780074002e00480074006d006c0034003000000002210f00004e0061657846494c454f5054002305000300000002210e00004e00616578464d544c4556002305000300000002210f01005600616578464e414d45494e002506010006000000210700004e007630002305032a0000000202211001005600616578464e414d454f5554002506010006000000210700004e0076300023170343003a005c004f00750074007000750074005c0000000202211300004e00616578464f4c4445524e4f54455300a3010002211000004e0061657847454e54454d504e00a3010002210f00004e0061657848545354414d5000a3010002210b00004e006165784e414d002305000100000002210d00004e006165785047524e47002305000000000002211000004e0061657850504c41554e434800a3010002210e00004e0061657850524445535400a3010002210e00004e006165785052504154480023250343005300490044004c005f004d00590044004f00430055004d0045004e0054005300000002210e00004e00616578505254595045002305000000000002211200004e00616578534156454c41554e434800a3010002210f00004e0061657853657373696f6e002305000000000002210e00004e00616578545354414d5000c30300000202210b0900630068706172616d00210b00007600616374696f6e00250600001e04000002210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305000e00000002210800004e00697469002305001e04000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305002200000002210c00004e007468636f756e7400230500ffffffff020202210d02007600616374686f73743100250602001a040000210b0500430061706172616d00210d00004e00616578505241505000a3010102210d00004e006165785052434f4e00a3010102210d00004e0061657850524f575200a3010102210d00004e00616578505250415300a3010102210e00004e00616578507764466c6700230500000000040202210b0900630068706172616d00210b00007600616374696f6e00250600001f04000002210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305000f00000002210800004e00697469002305001f04000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305000000000002210c00004e007468636f756e740023050001000000020202210b00004e00696e73746964002305001000000002210b00005600706172616d7300250600000100000002210a00004e0073746174650023050001000000022109000076007374657000250600000d0400000202210e0600760073746570686f73743300250606001b040000210d02007600616374686f73743000250602001a040000210b1100430061706172616d00211000004e00616578434f4e564e414d450023470343006f006e0076006500720074006500720073002e0054006500780074002e00540065007800740057006900740068004c0069006e00650062007200650061006b007300000002210f00004e0061657846494c454f5054002305000300000002210e00004e00616578464d544c4556002305000100000002210f01005600616578464e414d45494e002506010006000000210700004e007630002305032a0000000202211001005600616578464e414d454f5554002506010006000000210700004e0076300023170343003a005c004f00750074007000750074005c0000000202211300004e00616578464f4c4445524e4f54455300a3010002211000004e0061657847454e54454d504e00a3010002210f00004e0061657848545354414d5000a3010002210b00004e006165784e414d002305000100000002210d00004e006165785047524e47002305000000000002211000004e0061657850504c41554e434800a3010002210e00004e0061657850524445535400a3010002210e00004e006165785052504154480023150343003a005c004f0075007400700075007400000002210e00004e00616578505254595045002305000000000002211200004e00616578534156454c41554e434800a3010002210f00004e0061657853657373696f6e002305000000000002210e00004e00616578545354414d5000c30300000202210b0900630068706172616d00210b00007600616374696f6e00250600001e04000002210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305001100000002210800004e00697469002305001e04000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305002200000002210c00004e007468636f756e7400230500ffffffff020202210d02007600616374686f73743100250602001a040000210b0500430061706172616d00210d00004e00616578505241505000a3010102210d00004e006165785052434f4e00a3010102210d00004e0061657850524f575200a3010102210d00004e00616578505250415300a3010102210e00004e00616578507764466c6700230500000000040202210b0900630068706172616d00210b00007600616374696f6e00250600001f04000002210d00004e00657865636d6f6465002305000000000002210b00004e00696e73746964002305001200000002210800004e00697469002305001f04000002210800004e006f6c73002305000000000002210d00004e0070726f636f626a63002305000000000002210a00004e007374617465002305000100000002210d00004e0073796e636d6f6465002305000000000002210c00004e007468636f756e740023050001000000020202210b00004e00696e73746964002305001300000002210b00005600706172616d7300250600000100000002210a00004e0073746174650023050001000000022109000076007374657000250600000d0400000202210c04004300776670726f707300210a00004e00666e616d65002311034f00430052005f00500044004600000002210f00004e006e657874696e73746964002305001300000002210b00004e007766677569640023430346003700310032003000430038004500450036003100300034003600380035004100310038003000380043003200340046004200460045003000450046004100000002210e00004e0077667573657264656600a30100020202210b1c0043006974696d617000210900004e006b657930002305000304000002210900004e006b657931002305000704000002210a00004e006b65793130002305001f04000002210a00004e006b65793131002305002004000002210a00004e006b65793132002305002104000002210a00004e006b65793133002305002204000002210900004e006b657932002305000d04000002210900004e006b657933002305001804000002210900004e006b657934002305001904000002210900004e006b657935002305001a04000002210900004e006b657936002305001b04000002210900004e006b657937002305001c04000002210900004e006b657938002305001d04000002210900004e006b657939002305001e04000002210900004e0076616c300023210514ddba41d245b743b573901f7c636ce7327b1a22169ce04a8a4f6539b853d52c02210900004e0076616c310023210514ddba41d245b743b573901f7c636ce7950666dff7817e468ea55384df5a0c5902210a00004e0076616c3130002321051e5717b3d531584ab0e468455a0aa3b3fa00ab6715343d46a47b6b6118b4152f02210a00004e0076616c3131002321059011f5be85aa184db55ef213a97c3f69eb04f9d0695f6f47bbbc05903f928a4a02210a00004e0076616c3132002321059011f5be85aa184db55ef213a97c3f690a78e933465b5d45a6a9dd044869526f02210a00004e0076616c31330023210560b86d3f315f054b83f786ff6f2d075e2a70c4656adc9e408eac4a554b35e53202210900004e0076616c320023210514ddba41d245b743b573901f7c636ce7f16bae47c279f4448f67737337bcd14102210900004e0076616c33002321051e5717b3d531584ab0e468455a0aa3b3bcb201bd360f8a4799ab82e0333da05902210900004e0076616c34002321059011f5be85aa184db55ef213a97c3f69247ebbff7bca564a981a901bd23716be02210900004e0076616c35002321050fc81efabfdecd419d689838574420032d1f9eada5fa9b4194379d4f5e564e1902210900004e0076616c36002321050fc81efabfdecd419d6898385744200357c847b491f2e24fa9c5efa1e308faf802210900004e0076616c37002321050fc81efabfdecd419d68983857442003e88ebc30ac9d104c9eef9ce9cce8c00202210900004e0076616c38002321050fc81efabfdecd419d6898385744200311a86522b6b4ff4b997b4310f5e8fdff02210900004e0076616c39002321059011f5be85aa184db55ef213a97c3f69b0625c80b7bcc049917f3aca2f64cfc6020202";

		try {
			// Cria arquivo.xwf o qual ï¿½ apenas um arquivo de log, mas ï¿½ necessï¿½rio para o funcionamento
			byte logbyte[] = hexStringToByteArray( hexLogFileXWF );
			OutputStream osLog = new BufferedOutputStream( new FileOutputStream( pathLog/*.replace("c:", Constantes.SERVER)*/ ) );
			osLog.write( logbyte );
			osLog.close();

			// Cria Arquivo.jpf o qual contem os parametros para a execuï¿½ï¿½o do JobRunner
			byte paramters[] = hexStringToByteArray( hexParamtersFileJPF );
			OutputStream osParamters = new BufferedOutputStream( new FileOutputStream( pathParamters/*.replace("c:", Constantes.SERVER)*/ ) );
			osParamters.write( paramters );
			osParamters.close();
		} catch ( Exception e ) {
			System.err.println( e );
		}
	}

	public String convertStringToHex( String str ) {
		char[ ] chars = str.toCharArray();
		StringBuffer hex = new StringBuffer();
		for ( int i = 0; i < chars.length; i++ ) {
			hex.append( Integer.toHexString( (int) chars[ i ] ) );
			hex.append( "00" );
		}
		return hex.toString();
	}

	public static byte[ ] hexStringToByteArray( String s ) {
		int len = s.length();
		byte[ ] data = new byte[ len / 2 ];
		for ( int i = 0; i < len; i += 2 ) {
			data[ i / 2 ] = (byte) ( ( Character.digit( s.charAt( i ), 16 ) << 4 ) + Character.digit( s.charAt( i + 1 ), 16 ) );
		}
		return data;
	}
}